var SharedFolderDialog=function(e){var r={additionalHeaderClasses:["icon"],closeButtonEnabled:!0,maximizeButtonEnabled:!0,buttonAlign:this.RIGHT_ALIGN};Dialog.call(this,e,r),this.existingUsers=null,this.folder=null};SharedFolderDialog.prototype=Object.create(Dialog.prototype),SharedFolderDialog.prototype.constructor=SharedFolderDialog,function(e){SharedFolderDialog.prototype.initialize=function(e){Dialog.prototype.initialize.apply(this,arguments),function(e){var r,t=document.getElementById("sharedFolderDialogUserTypeahead");LPProxy.isEnterpriseUser()?(r=new BloodhoundDropdown(t,{identify:function(e){return"group"===e.type?e.cgid:e.uid},remote:{url:LPProxy.getBaseURL()+"typeahead_remote.php?grp=1&q=%QUERY",wildcard:"%QUERY"}},{optionLabel:function(e){var r=e.name;return"companyuser"===e.type?""===r?r=e.email:""!==e.email&&(r+=" ("+e.email+")"):r+=" ("+Strings.Vault.USER_GROUP+")",r},ignore:function(r,t){return e.existingUsers[r]||void 0===t.type&&!LPFeatures.allowShareOutsideEnterprise()}}),r.onChange(function(r,t){r=$.extend({},r);var i=SharedFolderUser;"group"===r.type&&(r.uid=r.cgid,delete r.cgid,i=SharedFolderUserGroup),r.username=r.email,delete r.email;var s=new i(r,e.folder);s._pending=!0,e.addNewUser(s),e.existingUsers[t]=!0}),e.inputFields.friends=r):e.inputFields.friends=r=new TypeaheadDropdown(t),LPProxy.isFamilyUser()?$("#sharedFolderDialogDisclaimer").show():$("#sharedFolderDialogDisclaimer").hide(),r.autocomplete=function(r){var t=r.target.value;if(null===this.hint&&t){for(var i=e.parseFriendsInput(t),s=0,a=i.length;s<a;++s)e.addNewUser(i[s]);r.preventDefault()}TypeaheadDropdown.prototype.autocomplete.apply(this,arguments)},Topics.get(Topics.REMOVED_SHARED_FOLDER_USER).subscribe(function(r){delete e.existingUsers[r.getID()],e.showHideInviteInput()}),$("#sharedFolderDialogInviteButton").bind("click",function(){e.submit()})}(this)},SharedFolderDialog.prototype.parseFriendsInput=function(e){for(var r=[],t=e.split(","),i=0,s=t.length;i<s;++i){var a,n=t[i].trim();if(n.indexOf("@")>-1){var o=n.match(Constants.EmailAddressRegularExpression);if(o&&1===o.length){var d=o[0];a=new SharedFolderUser({username:d},this.folder)}}else n&&(a=new SharedFolderUserGroup({name:n},this.folder));a&&(a._pending=!0,a.setEditable(!0),r.push(a))}return r},SharedFolderDialog.prototype.validate=function(e){var r=Dialog.prototype.validate.apply(this,arguments);return e.friends&&0===this.parseFriendsInput(e.friends).length&&(this.addError("friends","You must enter a valid email or group name."),r=!1),r},SharedFolderDialog.prototype.defaultFields=function(e){e.defaultData=$.extend({readonly:!0,hidePasswords:!0},e.defaultData),Dialog.prototype.defaultFields.call(this,e)},SharedFolderDialog.prototype.addNewUser=function(e){this.containers.newMembers||(this.containers.newMembers=new Container([],{additionalItemClasses:"dialogItem"}),this.containers.newMembers.initialize(document.getElementById("sharedFolderDialogNewUsersContainer"))),this.containers.newMembers.addChild(e),this.inputFields.friends.clear(),this.inputFields.friends.focus()},SharedFolderDialog.prototype.setup=function(r,t){Dialog.prototype.setup.apply(this,arguments),this.containers.existingMembers&&(this.containers.existingMembers.initialize(e.getElementById("folderMembers")),this.showHideInviteInput())},SharedFolderDialog.prototype.showHideInviteInput=function(){LPProxy.isEnterpriseUser()||(this.containers.existingMembers.getItemChildren().length>5?($("#sharedFolderMaxMembers").show(),$("#sharedFolderDialogInvites").hide()):($("#sharedFolderMaxMembers").hide(),$("#sharedFolderDialogInvites").show()))},SharedFolderDialog.prototype.open=function(e){this.folder=e,function(r){LPRequest.makeDataRequest(LPProxy.getSharedFolderMembers,{params:{shareid:e.getID()},success:function(t){for(var i=[],s=0,a=t.users.length;s<a;++s)i.push(new SharedFolderUser(t.users[s],e));for(var s=0,a=t.groups.length;s<a;++s)i.push(new SharedFolderUserGroup(t.groups[s],e));r.containers.existingMembers=new Container(i),r.existingUsers={};for(var s=0,a=i.length;s<a;++s)r.existingUsers[i[s].getID()]=!0;Dialog.prototype.open.call(r,{title:Strings.translateString("Manage Shared Folder")+": "+r.folder.getShareGroupName()})},error:function(){Topics.get(Topics.DIALOG_LOADED).publish()}})}(this)},SharedFolderDialog.prototype.getInvitedMembers=function(){var e=this.containers.newMembers?this.containers.newMembers.getItems():[];return e=e.concat(this.parseFriendsInput(this.inputFields.friends.getValue()))},SharedFolderDialog.prototype.getData=function(){var e=Dialog.prototype.getData.apply(this,arguments);e.newMembers={},e.updatedPermissions=[];var r=this.getInvitedMembers();if(r.length>0)for(var t=0,i=r.length;t<i;++t){var s=r[t];e.newMembers[s.getUsername()]={uid:s.getID(),type:s.getType()}}else for(var a=this.containers.existingMembers.getItemChildren(),t=0,i=a.length;t<i;++t){var n=a[t];n.isModified()&&e.updatedPermissions.push({uid:n.getID(!0),give:n.getCheckboxValue("give"),readonly:n.getCheckboxValue("readonly"),canadminister:LPProxy.isEnterpriseUser()?n.getCheckboxValue("can_administer"):"0"})}return e},SharedFolderDialog.prototype.handleSubmit=function(e){var r=$.extend(e,{sharedFolder:this.folder._data,shareInfo:this.folder._shareInfo});LPTools.hasProperties(e.newMembers)?LPRequest.makeRequest(LPProxy.addSharedFolderMembers,{params:r,requestSuccessOptions:{closeDialog:!1},success:this.createDynamicHandler(function(r){for(var t=[],i=this.getInvitedMembers(),s=0,a=i.length;s<a;++s){var n=i[s];r[n.getUsername()]&&(n._pending=!1,n._data.readonly=e.readonly?"1":"0",n._data.give=e.hidePasswords?"0":"1",n._data.can_administer=e.can_administer?"1":"0",n.rebuild(),t.push(n)),n._parent&&n._parent.removeChild(n)}this.containers.existingMembers.addChild(t),this.showHideInviteInput(),this.inputFields.friends.clear()})}):e.updatedPermissions.length>0?LPRequest.makeRequest(LPProxy.updateSharedFolderMemberPermissions,{params:r,success:this.createHandler(function(){for(var r=this.containers.existingMembers.getItemChildren(),t={},i=0,s=r.length;i<s;++i){var a=r[i];t[a.getID(!0)]=a}for(var i=0,s=e.updatedPermissions.length;i<s;++i){var n=e.updatedPermissions[i];t[n.uid].updatePermissions(n)}})}):this.close(!0)}}(document);